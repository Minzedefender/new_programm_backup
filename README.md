# Резервное копирование файловой базы 1С (PowerShell 5.1)

Скрипт `Backup1C.ps1` выполняет полный цикл резервного копирования файловых
баз 1С без дополнительных установок и зависимостей. Он запускает штатный
`1cv8.exe` в режиме `DESIGNER`, сохраняет дамп базы в формате `.dt`, очищает
устаревшие архивы и по необходимости выгружает результат в Яндекс.Диск через
официальный REST API с использованием OAuth-токена.

## Возможности

- Работает в стандартном PowerShell 5.1 и может быть вызван из `cmd.exe`.
- Использует только штатные инструменты Windows и платформы 1С.
- Шифрует токены, логины и пароли через `ConvertFrom-SecureString` и отдельный
  ключ AES (`secrets/key.bin`).
- Создаёт резервные копии `.dt` с меткой времени и автоматической ротацией по
  количеству дней.
- Отправляет файлы на Яндекс.Диск по OAuth-токену API (WebDAV не используется).
- Позволяет добавлять базы интерактивно и хранит настройки в `config.json`.

## Требования

- Windows с установленной платформой 1С (путь к `1cv8.exe` в конфигурации).
- PowerShell 5.1 (есть по умолчанию в Windows 10/Server 2016 и новее).
- OAuth-токен Яндекс.Диска (получается в личном кабинете).
- Права на запуск PowerShell-скриптов (при необходимости используйте
  `-ExecutionPolicy Bypass`).

## Файлы в репозитории

- `Backup1C.ps1` — основной сценарий.
- `config.sample.json` — пример конфигурации базы.
- `secrets/` — каталог для ключа и зашифрованных секретов (`.gitkeep` оставляет
  папку пустой в репозитории).
- `.gitignore` — исключает рабочий `config.json` и секреты из контроля версий.

## Первая настройка

Откройте PowerShell от имени пользователя, под которым будет выполняться
резервное копирование, и последовательно выполните:

1. **Создайте ключ для шифрования секретов** (один раз на пользователя):

   ```powershell
   powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action InitKey
   ```

   Ключ сохранится в `secrets\key.bin`. Без него прочитать сохранённые секреты
   невозможно.

2. **Запишите секреты** (логин/пароль 1С и токен облака). Значение можно передать
   параметром `-Value` или ввести вручную с двойным подтверждением:

   ```powershell
   powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action SetSecret -SecretName 1C_MAIN_USER
   powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action SetSecret -SecretName 1C_MAIN_PASSWORD
   powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action SetSecret -SecretName YANDEX_TOKEN
   ```

3. **Добавьте файловую базу**. Скрипт задаст вопросы о путях, сроке хранения и
   необходимости выгрузки в облако:

   ```powershell
   powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action AddBase
   ```

   Конфигурация сохранится в `config.json`. Для примера структуры можно
   посмотреть `config.sample.json`.

## Управление конфигурацией

- `Backup1C.ps1 -Action ListBases` — показать настроенные базы.
- `Backup1C.ps1 -Action RemoveBase -Name <имя>` — удалить запись из конфигурации.
- `Backup1C.ps1 -Action ListSecrets` — вывести список сохранённых секретов.
- `Backup1C.ps1 -Action SetSecret -SecretName <имя>` — создать или обновить
  секрет (повторный запуск перезаписывает значение).
- `Backup1C.ps1 -Action InitKey -Force` — пересоздать ключ (старые секреты станут
  недоступны).

## Запуск резервного копирования

Для запуска всех баз из PowerShell:

```powershell
powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action Run
```

Из командной строки `cmd.exe`:

```cmd
powershell.exe -ExecutionPolicy Bypass -File "%~dp0Backup1C.ps1" -Action Run
```

Для выборочного запуска используйте параметр `-Database` (можно указать несколько
значений):

```powershell
powershell -ExecutionPolicy Bypass -File .\Backup1C.ps1 -Action Run -Database "MainBase","Demo"
```

При успешном выполнении файлы вида `<ИмяБазы>_ГГГГММДД_ЧЧММСС.dt` появятся в
указанной папке, а при активированной выгрузке — ещё и в Яндекс.Диске.

## Настройка планировщика заданий

1. Создайте в Планировщике новое задание.
2. В разделе **Действия** укажите:
   - Программа: `powershell.exe`
   - Аргументы: `-ExecutionPolicy Bypass -File "C:\Scripts\Backup1C.ps1" -Action Run`
3. Запускайте от того же пользователя, для которого инициализированы секреты.
4. При необходимости добавьте триггеры по расписанию.

## Формат `config.json`

Каждая база описывается JSON-объектом. Пример с комментариями:

```json
{
  "Bases": [
    {
      "Name": "MainBase",
      "DatabasePath": "C:\\1C\\Bases\\MainBase",
      "DesignerPath": "C:\\Program Files\\1cv8\\8.3.xxx\\bin\\1cv8.exe",
      "BackupDirectory": "D:\\Backups\\1C\\MainBase",
      "RetentionDays": 7,
      "UserSecret": "1C_MAIN_USER",
      "PasswordSecret": "1C_MAIN_PASSWORD",
      "Upload": {
        "Enabled": true,
        "RemoteDirectory": "/Backups/1C/MainBase",
        "TokenSecret": "YANDEX_TOKEN"
      }
    }
  ]
}
```

Поля:

- `Name` — произвольное имя базы, используется в именах файлов.
- `DatabasePath` — каталог, где расположен `1Cv8.1CD` и служебные файлы.
- `DesignerPath` — путь к `1cv8.exe` нужной версии.
- `BackupDirectory` — папка для сохранения `.dt` (создаётся автоматически).
- `RetentionDays` — сколько дней хранить бэкапы (0 или пусто — без удаления).
- `UserSecret` / `PasswordSecret` — имена секретов с логином и паролем 1С.
- `Upload.Enabled` — флаг выгрузки в облако.
- `Upload.RemoteDirectory` — папка в Яндекс.Диске (должна начинаться с `/`).
- `Upload.TokenSecret` — имя секрета с OAuth-токеном API.

Можно редактировать `config.json` вручную (после остановки задач) или через
интерактивную команду `AddBase`.

## Зашифрованные секреты

- Ключ хранится в `secrets/key.bin` и привязан к пользователю Windows.
- Значения записываются в `secrets/secrets.json` в зашифрованном виде.
- Без ключа расшифровать секреты невозможно, поэтому храните резервную копию.
- Перезапись ключа (команда `InitKey -Force`) делает старые секреты
  невалидными — их нужно задать заново.

## Загрузка на Яндекс.Диск

Скрипт использует REST API Яндекс.Диска. OAuth-токен передаётся в заголовке
`Authorization: OAuth <token>`. Для каждого файла выполняется запрос на получение
ссылки загрузки, после чего содержимое отправляется методом `PUT`. Поддерживается
только работа по токену, авторизация логином/паролем не используется.

## Очистка старых бэкапов

После успешного создания `.dt`-файла скрипт удаляет архивы, которые старше
указанного количества дней. Очистка происходит только внутри каталога,
определённого в `BackupDirectory`, и затрагивает файлы текущей базы по маске
`<ИмяБазы>_*.dt`.

---

Скрипт можно расширять (например, добавлять копирование на сетевые диски или
уведомления) без дополнительных библиотек: достаточно встроенных средств
PowerShell 5.1.